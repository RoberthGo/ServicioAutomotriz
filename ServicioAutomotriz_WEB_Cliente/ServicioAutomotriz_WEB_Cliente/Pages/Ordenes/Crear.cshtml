@page
@model ServicioAutomotriz_WEB_Cliente.Pages.Ordenes.CrearModel
@{
    ViewData["Title"] = "Nueva Orden de Servicio";
}

<div class="container py-4">
    <h4 class="mb-4 fw-bold">Registro de Orden de Servicio</h4>

    <form method="post" id="formOrden">
        @Html.AntiForgeryToken()

        <!-- FOLIO y FECHA -->
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="row align-items-center mb-2">
                    <label class="col-sm-3 col-form-label text-end fw-semibold">FOLIO:</label>
                    <div class="col-sm-6">
                        <input type="text" class="form-control form-control-sm"
                               style="background-color:#fff3cd;" value="(automático)" readonly />
                    </div>
                </div>
                <div class="row align-items-center">
                    <label class="col-sm-3 col-form-label text-end fw-semibold">FECHA:</label>
                    <div class="col-sm-6">
                        <input type="text" id="fechaAuto" class="form-control form-control-sm"
                               style="background-color:#fff3cd;" readonly
                               asp-for="Input.EntryDate" />
                    </div>
                </div>
            </div>
        </div>

        <!-- CLIENTE -->
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="row align-items-center mb-2">
                    <label class="col-sm-3 col-form-label text-end fw-semibold">CLIENTE:</label>
                    <div class="col-sm-6">
                        <input type="text" class="form-control form-control-sm"
                               style="background-color:#fff3cd;"
                               placeholder="RFC"
                               asp-for="Input.RFC"
                               maxlength="13" />
                        <span asp-validation-for="Input.RFC" class="text-danger small"></span>
                    </div>
                </div>
                <div class="row align-items-center">
                    <div class="col-sm-3"></div>
                    <div class="col-sm-6">
                        <input type="text" class="form-control form-control-sm"
                               style="background-color:#fff3cd;"
                               placeholder="NOMBRE"
                               asp-for="Input.CustomerName" />
                        <span asp-validation-for="Input.CustomerName" class="text-danger small"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- AUTO -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="row align-items-center mb-2">
                    <label class="col-sm-3 col-form-label text-end fw-semibold">AUTO:</label>
                    <div class="col-sm-6">
                        <input type="text" class="form-control form-control-sm"
                               style="background-color:#d4edda;"
                               placeholder="NÚMERO DE SERIE"
                               asp-for="Input.SerialNumber" />
                        <span asp-validation-for="Input.SerialNumber" class="text-danger small"></span>
                    </div>
                </div>
                <div class="row align-items-center">
                    <div class="col-sm-3"></div>
                    <div class="col-sm-6">
                        <input type="text" class="form-control form-control-sm"
                               style="background-color:#d4edda;"
                               placeholder="DESCRIPCIÓN (Marca / Modelo / Año)"
                               asp-for="Input.VehicleDescription" />
                        <span asp-validation-for="Input.VehicleDescription" class="text-danger small"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- TABLA DE SERVICIOS -->
        <div class="row mb-2">
            <div class="col-md-10">
                <table class="table table-bordered table-sm" id="tablaServicios">
                    <thead>
                        <tr style="background-color:#d4edda;">
                            <th class="text-center" style="width:130px;">ID SERVICIO</th>
                            <th>DESCRIPCIÓN</th>
                            <th class="text-center" style="width:100px;">CANTIDAD</th>
                            <th class="text-end" style="width:120px;">PRECIO</th>
                            <th class="text-end" style="width:120px;">IMPORTE</th>
                            <th class="text-center" style="width:60px;"></th>
                        </tr>
                    </thead>
                    <tbody id="filasCuerpo">
                        <!-- filas dinámicas -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Botón agregar servicio -->
        <div class="row mb-3">
            <div class="col-md-10">
                <button type="button" class="btn btn-sm btn-outline-success" onclick="agregarFila()">
                    + Agregar Servicio
                </button>
            </div>
        </div>

        <!-- TOTALES -->
        <div class="row mb-4">
            <div class="col-md-10 d-flex justify-content-end">
                <table class="table table-sm table-borderless" style="width:300px;">
                    <tr>
                        <td class="text-end fw-semibold">SUBTOTAL</td>
                        <td class="text-end fw-bold" style="background-color:#fd7e14; color:#fff; min-width:110px;" id="lblSubtotal">$0.00</td>
                    </tr>
                    <tr>
                        <td class="text-end fw-semibold">IVA (16%)</td>
                        <td class="text-end fw-bold" style="background-color:#fd7e14; color:#fff;" id="lblIva">$0.00</td>
                    </tr>
                    <tr>
                        <td class="text-end fw-semibold">TOTAL</td>
                        <td class="text-end fw-bold" style="background-color:#fd7e14; color:#fff;" id="lblTotal">$0.00</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- campos ocultos para enviar los servicios al servidor -->
        <div id="camposOcultos"></div>

        <!-- FECHA ESTIMADA DE ENTREGA -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="row align-items-center">
                    <label class="col-sm-4 col-form-label text-end fw-semibold">ENTREGA EST.:</label>
                    <div class="col-sm-6">
                        <input type="datetime-local" class="form-control form-control-sm"
                               asp-for="Input.EstimatedDeliveryTime" />
                        <span asp-validation-for="Input.EstimatedDeliveryTime" class="text-danger small"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- BOTONES -->
        <div class="row">
            <div class="col-md-10 d-flex gap-2 justify-content-end">
                <a asp-page="/Index" class="btn btn-secondary">Cancelar</a>
                <button type="submit" class="btn btn-primary">Guardar Orden</button>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Mostrar fecha/hora actual automáticamente
        (function () {
            const now = new Date();
            const pad = n => String(n).padStart(2, '0');
            const formatted = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} `
                            + `${pad(now.getHours())}:${pad(now.getMinutes())}`;
            document.getElementById('fechaAuto').value = formatted;
        })();

        let filaIndex = 0;

        function agregarFila() {
            filaIndex++;
            const tbody = document.getElementById('filasCuerpo');
            const tr = document.createElement('tr');
            tr.id = `fila_${filaIndex}`;
            tr.innerHTML = `
                <td><input type="number" class="form-control form-control-sm text-end"
                     name="servicioId_${filaIndex}" min="1" placeholder="ID"
                     oninput="recalcular()" /></td>
                <td><input type="text" class="form-control form-control-sm"
                     name="servicioDesc_${filaIndex}" placeholder="Descripción del servicio" /></td>
                <td><input type="number" class="form-control form-control-sm text-center cantidad"
                     name="servicioCant_${filaIndex}" value="1" min="1"
                     oninput="actualizarImporte(${filaIndex})" /></td>
                <td><input type="number" class="form-control form-control-sm text-end precio"
                     name="servicioPrecio_${filaIndex}" value="0" min="0" step="0.01"
                     oninput="actualizarImporte(${filaIndex})" /></td>
                <td class="text-end align-middle fw-semibold importe" id="importe_${filaIndex}">$0.00</td>
                <td class="text-center align-middle">
                    <button type="button" class="btn btn-sm btn-outline-danger"
                            onclick="eliminarFila(${filaIndex})">?</button>
                </td>`;
            tbody.appendChild(tr);
        }

        function eliminarFila(idx) {
            const fila = document.getElementById(`fila_${idx}`);
            if (fila) fila.remove();
            recalcular();
        }

        function actualizarImporte(idx) {
            const fila = document.getElementById(`fila_${idx}`);
            if (!fila) return;
            const cant = parseFloat(fila.querySelector('.cantidad').value) || 0;
            const precio = parseFloat(fila.querySelector('.precio').value) || 0;
            const importe = cant * precio;
            fila.querySelector(`#importe_${idx}`).textContent = formatMXN(importe);
            recalcular();
        }

        function recalcular() {
            let subtotal = 0;
            document.querySelectorAll('#filasCuerpo tr').forEach(tr => {
                const cant = parseFloat(tr.querySelector('.cantidad')?.value) || 0;
                const precio = parseFloat(tr.querySelector('.precio')?.value) || 0;
                subtotal += cant * precio;
            });
            const iva = subtotal * 0.16;
            const total = subtotal + iva;
            document.getElementById('lblSubtotal').textContent = formatMXN(subtotal);
            document.getElementById('lblIva').textContent = formatMXN(iva);
            document.getElementById('lblTotal').textContent = formatMXN(total);
        }

        function formatMXN(value) {
            return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(value);
        }
    </script>
}
